# 概要
コンソール上で「デプロイグループの作成」を実施する際の各種項目を解説する。

# 各種設定項目解説
## デプロイ設定
### トラフィックの再ルーティング
- すぐにトラフィックを再ルーティング
  - こちらは「自動ルーティング」
  - Blue/Greenデプロイの過程で、Green側のECS等のタスク作成が完了した時点で、自動的にGreen側のタスクへルーティングを切り替える
- トラフィックを再ルーティングするタイミングを指定します
  - こちらは「手動ルーティング」
  - Blue/Greenデプロイの過程で、Green側のECS等のタスク作成が完了した後、手動でGreen側のタスクへルーティングを切り替える必要がある。
  - 設定した時間を超えても「トラフィックの再ルーティング」ボタンを押下しない場合、タイムアウトエラーが発生する。  

**※「トラフィックを再ルーティングするタイミングを指定します」を選択した場合**  
- 「手動ルーティング」する場合、下記画像のタイミングで「トラフィックの再ルーティング」を押す。
- この段階で、切り替え先の新たなタスクは起動しており、ターゲットグループによるヘルスチェックも終了している。
- ここで設定した時間を経過しないと、ステップ4へ移行しない。

<img src="https://github.com/adgjmptwgw/infra-note/assets/66456130/34ee5a35-cf6b-4c40-b48f-f971996b2552" width="80%">


**<参考資料>**  
- [**トラフィックの再ルーティングについて**](https://dev.classmethod.jp/articles/20220422-codedeploy-bg-cli/)
- [**AWS公式：「すぐにトラフィックを再ルーティング」についての記載ページ**](https://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/deployment-groups-create-ecs.html)

### 元のリビジョンの終了
- Blue/Greenデプロイが完了し、切替前に使用していたECSのタスクを何時間後に終了させるか設定できる。
- もし、新しいタスクに問題があった場合にすぐにロールバックできるよう、切替前タスクの停止時間を設定する。
- ここで設定した時間を経過しないと、ステップ6へ移行しない。

<img src="https://github.com/adgjmptwgw/infra-note/assets/66456130/d71a6845-e520-4d74-b31d-7363b3bbe543" width="80%">

## トリガー
「デプロイ失敗」「デプロイ停止」等のイベントが発生した際にAmazon SNSを使用して通知が可能。

## ロールバック
「ロールバックを無効にする」を選択すると、自動ロールバックが実施されない。手動にてロールバックを行う必要がある。「ロールバックを無効にする」にチェックを入れない場合、下記の自動ロールバック設定をする必要がある。

- デプロイが失敗したときにロールバックする
- アラームのしきい値が一致したときにロールバックする
