# 監視項目
各サービスのメトリクスアラートを作成するにあたり、どのようなメトリクスが重要なのかまとめる。  

**<参考資料>**  
- [最低限監視するアラーム](https://mazyu36.hatenablog.com/entry/2023/02/24/184347#%E3%83%A1%E3%83%88%E3%83%AA%E3%82%AF%E3%82%B9%E7%9B%A3%E8%A6%96)

# ALB
## UnHealthyHostCount （重要度：高）
ヘルスチェックで異常検知されたターゲットの数

## TargetConnectionErrorCount （重要度：？？？）
- ロードバランサーとターゲット間で正常に確立されなかった接続数。
  - ヘルスチェックで気付けるからいらない？？？（個人意見）
- 504エラーが出た時にこのカウントが増えている可能性あり？（[**AWS公式：ALB 504エラーのトラブルシューティング**](https://repost.aws/ja/knowledge-center/504-error-alb)）

**<参考資料>**  
- [**AWS公式：ALBのアラーム**](https://docs.aws.amazon.com/ja_jp/elasticloadbalancing/latest/application/load-balancer-cloudwatch-metrics.html)
- [**ALBのアラームについて**](https://www.datadoghq.com/ja/blog/aws-monitoring/)

# ECS
TBD

## コンテナログ（アプリケーションのログ）
ECS上のアプリケーションで発生したエラーを通知する場合、CloudWatchのサブスクリプションフィルターを用いて実装する。  
**※ECSはメトリクス監視以外にアプリケーションエラー発生時の通知を行う必要がある。CloudWatch Alarmには関係ないが、参考として記載する。**

**<参考資料>**  
- [コンテナログの通知方法](https://awstut.com/2022/07/31/subscription-filter-to-extract-errors-in-fargate-container-logs-and-notify-by-email/)

# Cognito

## メモ
```
【Cognito】
Cognitoの監視ベストプラックティス引用

特に以下 3点を監視しておくことをオススメします。
　・API の Rate limit
　・サインアップやサインインなどのオペレーションの成功割合
　・セキュリティ上のリスクの検出数

・APIコール（ThrottleCount）
APIの呼び出し回数がService Quotasの設定値の上限にかかる場合、早期に対応できるため。
想定以上にユーザー数が多かったり、Cognitoとやりとりをする場合は必要？今回は多分いらない（楠本）
・オペレーションの成功割合（Successes）
サインアップ、サインインの成功割合を監視する。
平常時と比べてあまりに割合が低いようなら、攻撃に晒されている可能性がある。
・リスクの検出数（Risk）
　Cognito に「セキュリティ上のリスクあり」と判定された試行数
　<リスクの種類>
　いずれも PasswordChange、SignIn、SignUp 操作時のリスクです。
　・CompromisedCredentialRisk	漏洩した認証情報を用いた試行
　・AccountTakeOverRisk	アカウントの乗っ取りが疑われる試行
　・OverrideBlock	管理者の設定によりブロックされた試行 (※)
<参考資料>
・Cognitoの監視ベストプラックティス
```

**<参考資料>**  
- [**アプリの一般的なログイン成功率**](https://mnb.macnica.co.jp/2020/10/post-20.html)

# AWS batch
AWS Batch失敗通知はCloudWatch Alarmには関係ないが、参考として記載する。

**<参考資料>**  
- [**AWS公式：Batch失敗時の通知**](https://docs.aws.amazon.com/ja_jp/batch/latest/userguide/batch_sns_tutorial.html)


# OpenSearch
OpenSearchアラームに関しての超重要資料を添付している為、要確認。  
また、OpenSearchの各用語については[**こちら**](https://github.com/adgjmptwgw/aws-practice/blob/main/src/basics/open-search/note/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E4%BD%9C%E6%88%90.md)

**<参考資料>**  
- [**OpenSearchで推奨されるCloudWatchアラーム**](https://docs.aws.amazon.com/ja_jp/opensearch-service/latest/developerguide/cloudwatch-alarms.html)

## ClusterStatus.red
「クラスターステータス：赤」

> 赤のクラスター状態が 2 週間を超えて続くと、最後に正常な自動スナップショットが削除され、クラスターのデータが完全に失われることになります。

## 5xx
TBD

**<参考資料>**  
- [**AWS公式：504エラー（タイムアウトエラー）を防ぐには**](https://repost.aws/ja/knowledge-center/opensearch-http-504-gateway-timeout)

## ThreadpoolWriteQueue 
書き込みリクエストが多すぎて、429エラーが発生する可能性がある。

**<参考資料>**  
- [**AWS公式：OpenSearchの書き込み拒否(429エラー)**](https://repost.aws/ja/knowledge-center/opensearch-resolve-429-error)
- [**429エラー原因**](https://zenn.dev/tkykenmt/articles/a789d533b96206)

## ThreadpoolSearchQueue  
読み込みリクエストが多すぎて、429エラーが発生する可能性がある。

**<参考資料>**  
- [**AWS公式：OpenSearchの検索拒否(429エラー)**](https://repost.aws/ja/knowledge-center/opensearch-resolve-429-error)
- [**429エラー原因**](https://zenn.dev/tkykenmt/articles/a789d533b96206)


## AutomatedSnapshotFailure 
- スナップショットの失敗を検知
- スナップショットが失敗すると、「クラスターステータス：赤」となる為、このアラームは不要？？？クラスターステータス以外が原因でスナップショットに失敗する可能性もあるかも・・・
> 赤のクラスター状態は、少なくとも 1 つのプライマリシャードとそのレプリカがノードに割り当てられていないことを意味します。OpenSearch Service は、インデックスの状態にかかわらず、すべてのインデックスの自動スナップショットを取得しようとしますが、赤色のクラスター状態が維持されている間、スナップショットは失敗します。

## MasterReachableFromNode
- ヘルスチェックに失敗すると0を出力する
- ヘルスチェックに失敗すると、クラスターステータスはredになる為、このメトリクスのアラームは不要？？？（[**AWS公式:ヘルスチェック失敗時のクラスターステータス**](https://repost.aws/ja/knowledge-center/opensearch-dashboards-red-status)）

