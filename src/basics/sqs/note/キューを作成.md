# 概要
コンソール上で「キューを作成」を実施する際の各種項目を解説する。

# 前提知識
## 可視性タイムアウト
### ● 概要
可視性タイムアウト時間中は次のキューを処理できない。  

**【例：可視性タイムアウト時間が1分の場合】**  
先頭のメッセージが処理されている間は論理削除の様な状態となる。キューの処理が完了すると、物理削除として完全にキューから削除される。
先頭である "メッセージ1" を処理している場合、1分間は "メッセージ2" を処理できない。※"メッセージ1"の処理が終われば、次のメッセージを処理できます。  
逆に1分が経過しても、 "メッセージ1" の処理が終わっていない場合、別のコンシューマー（Lambda等）が "メッセージ1" の処理を実行する。  
想定される処理時間以下で、「可視性タイムアウト時間」を設定すると、処理が重複して実行されてしまう為、**「想定される処理時間 < 可視性タイムアウト時間」 となるように設定する。**  

もし、可視性タイムアウトが短すぎると、メッセージの重複処理が実行されてしまう点に注意。

### ● なぜ先頭メッセージの処理を開始した時点で、キューからメッセージを削除しないのか
コンシューマー（Lambda等）により、先頭のメッセージを処理する際、ネットワークの問題や何らかのエラーが起きた場合、キューが完全に消失する事を防ぐため。  
コンシューマーによる処理が完了してから、正式に先頭メッセージを削除する。  

![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/9fe67297-6012-41a6-bb73-96a9934af241)

### ● 可視性タイムアウトの比較
- 可視性タイムアウトが短すぎる => 処理が重複して実行されてしまう
- 可視性タイムアウトが長過ぎる => 前回の処理が失敗した場合にメッセージを再度処理しようとすると、比較的長い時間待つ必要

### ● 可視性タイムアウトの設定方法
- 処理時間が分かる場合
- 処理時間が分からない場合  
ハートビート機能を用いる。これはchangeMessageVisibility API コールを使用して可視性タイムアウトを延長する機能。  

**<参考資料>**  
- [**AWS公式：ハートビートの作成**](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/APIReference/API_ChangeMessageVisibility.html)  
- [**AWS公式：SDK V3 for JS**](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/sqs/command/ChangeMessageVisibilityCommand/)

# 作成手順

## 設定 
### ● 可視性タイムアウト
上記の「前提知識 > 可視性タイムアウト」を参考に設定する。

### ● メッセージ保持期間
- キューが最初に登録されてから自動削除されるまでの時間。
- メッセージがDLQに移動したとしても、元のキューの「メッセージ保持期間」 が適用される。メッセージ保持期間が4日の場合、元のキューで1日 → DLQで3日経過でメッセージが削除される。

### ● 配信遅延
- キューに登録されたメッセージは設定した時間の間、コンシューマー（Lambda等）から読み込まれない。
- n分後にメールを送信したい場合に用いる

### ● 最大メッセージサイズ
- 参考として、40個のkeyとvalueがあるJSONオブジェクトが300個で260KB程度となってしまう。
- その為、SQSでは大きなデータを送信する場合はS3のファイルパスをメッセージに添付して送信した方が良い。

### ● メッセージ受信待機時間
- キューにポーリング（メッセージがあるかどうかリクエストを投げる）頻度を設定する
- 0秒に設定したものをショートポーリング。1秒以上に設定ているものをロングポーリングという
- ショートポーリングはロングポーリングより料金がかかるので、最適な秒数を設定する。
  - Lambdaと組み合わせた場合のショートポーリングは15回/1分という頻度で、SQS一つ当たり月に64万リクエストとなる。その為、キュー1つに付き0.32USD/月の料金となる。その為、そもそもショートポーリングでもそこまで料金はかからない。（[**参考記事**](https://encr.jp/blog/posts/20200326_morning/)）

## 許可ポリシーの再実行
このキューをDLQとして使用する場合はこちらを設定する。どこからのキューを受け付けるか設定できる。

## デッドレターキュー
- 「有効」に設定した場合、処理に失敗したメッセージの送信先のDLQを選択する。
- 最大受信数（リトライ回数）：処理に失敗した場合、何回リトライするのか設定する。リトライ回数分失敗すると、メッセージがDLQにキューイングされる。　

# メモ（後で手順に追加）
