# 概要
コンソール上で「新しいタスクの定義の作成」を実施する際の各種項目を解説する。
※起動タイプはFargate

# 前提知識
## ECSの構成
### ● コントロールプレーン
- データプレーンに指示を出すもの

### ● データプレーン（ECSでは コンテナエージェント という名称）
- データプレーンからの指示を実行するリソース
- レジストリにdocker login、docker pull、ECSでdocker run、docker stop等を実行する

<img src="https://github.com/adgjmptwgw/aws-practice/assets/66456130/cb6f045c-0928-4996-9c37-d6240b139f21" width="70%">
<img src="https://github.com/adgjmptwgw/aws-practice/assets/66456130/d64cbf09-87c0-475d-86df-d62eb28238ad" width="70%">


# 手順
## インフラストラクチャの要件
### ● OS、アーキテクチャ、ネットワークモード
- オペレーティングシステム/アーキテクチャ  
料金は ```ARM < 86X < Windows Server``` の順   

**<参考資料>**  
- [**86X/ARMの解説**](https://github.com/adgjmptwgw/aws-practice/blob/main/src/basics/ec2/instance/note/%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%AE%E8%B5%B7%E5%8B%95.md#cpu%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3)
- [**AWS公式：86X/ARM/Windows Serverの料金**](https://aws.amazon.com/jp/fargate/pricing/)

### ● タスクサイズ
- 特に規模感が分からない場合、一旦基本的なスペックで様子見する。0.5vCPU、1GiB
- クラスター作成時に Container Insights を有効化して、コンピューティングリソースと費用を最適化していく

### ● 条件付きのタスクロール
- **タスクロール**
  - コンテナ内のアプリケーションが他のリソースを操作するのに必要なロール
  - 例えば、S3からファイルを取得する、RDSからデータを取得する等の場合に設定が必要

<img src="https://github.com/adgjmptwgw/aws-practice/assets/66456130/8dec2710-d2e9-4b68-88a9-6eca1e882c45" width="70%">

- **タスク実行ロール**
  - ECR にあるコンテナイメージを使う
  - CloudWatch Logs にログを保存する
  - タスク定義の環境変数に AWS Secret Manager パラメータストアの値を利用する（こちらは使用する場合必要で、基本はポリシーに含まれていないと思われる）

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
　　　　　　　　　// ECRにアクセスする際、Secret Managerで設定した認証を実行できるポリシー
                "ecr:GetAuthorizationToken",
　　　　　　　　　// リポジトリ内の1つ以上のイメージレイヤーが利用可能かどうか確認
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
　　　　　　　　　// イメージを取得する
                "ecr:BatchGetImage",
　　　　　　　　　// CloudWatchログストリームの作成（インスタンスや監視対象のログ）
                "logs:CreateLogStream",
　　　　　　　　　// CloudWatchログストリームへログを送信する
                "logs:PutLogEvents"
            ],
            "Resource": "*"
        }
    ]
}
```

## コンテナ
### ● プライベートレジストリ認証
- ECS コンテナエージェントがECRのレジストリにアクセスする際、AWS Secret Managerを使って認証させるかどうか設定できる。
- おそらくタスク実行ロール の ecsTaskExecutionRole ロールにある GetAuthorizationToken ポリシーが必要？

### 読み取り専用ルートファイルシステム
コンテナのファイルシステム（Linux）をRead onlyにする設定。ファイルシステム（Linux）のルートディレクトリ以下のファイルの作成、編集、削除ができなくなる。  

**メリット**  
- マルウェア対策となる

**デメリット**  
- ECS Exec が使えなくなる。
  - 以前はECSのコンテナに入ることはできなかったが、```aws ecs execute-command``` コマンドの登場で、起動中のコンテナに入り、デバッグができるようになった。

### ● 環境変数 
内部的にコンテナを起動する際に```docker run```を実行するが、ここで環境変数を設定すると、```docker run --env```として起動し、環境変数オプションでコンテナを起動できる。

> コンテナに渡す環境変数。このパラメータは、Docker Remote API のコンテナの作成セクションの Env にマップされ、--env オプションは docker run にマップされます。

**<引用の参考資料>**  
[**AWS公式：タスク定義パラメータ**](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/userguide/task_definition_parameters.html)

### ● ログ収集
- Amazon CloudWatch
  - CloudWatchにストリームが作成される。
  - 各種デフォルト項目
    - awslogs-group：CloudWatchのロググループ名
    - awslogs-region：ロググループが作成されるリージョン
    - awslogs-stream-prefix：ログログストリームのprefix
  - 参考記事：[**ECSのログストリーム階層構成**](https://developer.hatenastaff.com/entry/2021/08/19/093000)

![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/a0cc44fa-ba7b-4db9-9358-f2b0030c9ed7)

- FireLens
  - FireLensはログをルーティングするサービス。Fluent Bitというログ収集のサードパーティーツールが組み込まれている？？？
  - S3, Kinesis Data Firehose, OpenSearch等にログを送信できる

![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/055f927a-81f5-4910-9c69-18fb2683c3bc)

### ● ヘルスチェック
**● 概要**  
コマンドにてコンテナのヘルスチェックを実施する。下記の通り、ヘルスチェックに失敗したタスクは停止する。停止後、サービススケジュールにより新たなタスクに置き換えられる。また、ヘルスチェックの各種項目の解説は公式ページが分かりやすい為、「参考記事」を参照。
> サービスの一部ではなく手動で実行されたタスクについては、そのライフサイクルがヘルスステータスに関係なく継続されます。サービスの一部であるタスクで異常が報告された場合には、そのタスクは停止し、サービススケジューラにより置き換えられます。

**● コマンド**  
ECSタスク定義のコマンドはDockerのヘルスチェックコマンドがマッピングされている。

**<Dockerコマンド>**
```
HEALTHCHECK --interval=5m --timeout=3s \
  CMD curl -f http://localhost/ || exit 1
```
**<ECSタスク定義のコマンド>**
- ```CMD-SHELL``` はECSのコンテナのデフォルトshellを使用するという意味  
- ```exit 1``` ヘルスチェックは0出力が成功、1出力がエラー。その為、```exit 1```は失敗時にエラーを出力するという意味。  
```
CMD-SHELL, curl -f http://localhost/ || exit 1
```

**● ヘルスチェック時の注意点**  
- 先にローカルでヘルスチェックが成功する事を確認する
- コンテナの起動に時間がかかると、コンテナのヘルスチェックに失敗する可能性がある為、「開始期間（startPeriod）」を調整する。※参考記事の「AWS公式ヘルスチェック失敗時の対処法」を参照

**● その他**  
DBコンテナのヘルスチェック例？？？mysqlコンテナとmariadbコンテナの場合、このコマンドが成功すればコンテナが起動している。
```CMD-SHELL,mysqladmin ping -u [mysqlのユーザー名] -p[パスワード] -h 127.0.0.1 || exit 1```  

**参考資料**  
- [**AWS公式：ヘルスチェック失敗時の動作について記載**](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task_definition_parameters.html#container_definition_healthcheck?icmpid=docs_ecs_hp-task-definition)
- [**AWS：ヘルスチェック各項目の解説**](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task_definition_parameters.html#container_definition_healthcheck?icmpid=docs_ecs_hp-task-definition)
- [**AWS公式ヘルスチェック失敗時の対処法**](https://repost.aws/ja/knowledge-center/ecs-task-container-health-check-failures)


### ● Docker設定
