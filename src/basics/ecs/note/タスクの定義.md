# 概要
コンソール上で「新しいタスクの定義の作成」を実施する際の各種項目を解説する。
※起動タイプはFargate

# 前提知識
## ECSの構成
### ● コントロールプレーン
- データプレーンに指示を出すもの

### ● データプレーン（ECSでは コンテナエージェント という名称）
- データプレーンからの指示を実行するリソース
- レジストリにdocker login、docker pull、ECSでdocker run、docker stop等を実行する

<img src="[画像のURL](https://github.com/adgjmptwgw/aws-practice/assets/66456130/cb6f045c-0928-4996-9c37-d6240b139f21)" width="50%">

![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/cb6f045c-0928-4996-9c37-d6240b139f21)
![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/d64cbf09-87c0-475d-86df-d62eb28238ad)



# 手順
## インフラストラクチャの要件
### ● OS、アーキテクチャ、ネットワークモード
- オペレーティングシステム/アーキテクチャ  
料金は ```ARM < 86X < Windows Server``` の順   

**<参考資料>**  
- [**86X/ARMの解説**](https://github.com/adgjmptwgw/aws-practice/blob/main/src/basics/ec2/instance/note/%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%AE%E8%B5%B7%E5%8B%95.md#cpu%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3)
- [**AWS公式：86X/ARM/Windows Serverの料金**](https://aws.amazon.com/jp/fargate/pricing/)

### ● タスクサイズ
- 特に規模感が分からない場合、一旦基本的なスペックで様子見する。0.5vCPU、1GiB
- クラスター作成時に Container Insights を有効化して、コンピューティングリソースと費用を最適化していく

### ● 条件付きのタスクロール
- **タスクロール**
  - TBD

- **タスク実行ロール**
  - ECR にあるコンテナイメージを使う
  - CloudWatch Logs にログを保存する
  - タスク定義の環境変数に AWS Secret Manager パラメータストアの値を利用する（こちらは使用する場合必要で、基本はポリシーに含まれていないと思われる）

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
　　　　　　　　　// ECRにアクセスする際、Secret Managerで設定した認証を実行できるポリシー
                "ecr:GetAuthorizationToken",
　　　　　　　　　// リポジトリ内の1つ以上のイメージレイヤーが利用可能かどうか確認
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
　　　　　　　　　// イメージを取得する
                "ecr:BatchGetImage",
　　　　　　　　　// CloudWatchログストリームの作成（インスタンスや監視対象のログ）
                "logs:CreateLogStream",
　　　　　　　　　// CloudWatchログストリームへログを送信する
                "logs:PutLogEvents"
            ],
            "Resource": "*"
        }
    ]
}
```

## コンテナ
### ● プライベートレジストリ認証
- ECS コンテナエージェントがECRのレジストリにアクセスする際、AWS Secret Managerを使って認証させるかどうか設定できる。
- おそらくタスク実行ロール の ecsTaskExecutionRole ロールにある GetAuthorizationToken ポリシーが必要？

### ● 環境変数 
> コンテナに渡す環境変数。このパラメータは、Docker Remote API のコンテナの作成セクションの Env にマップされ、--env オプションは docker run にマップされます。

**<引用の参考資料>**  
[**AWS公式：タスク定義パラメータ**](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/userguide/task_definition_parameters.html)

### ● Docker設定
