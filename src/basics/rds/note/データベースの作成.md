# 概要
コンソール上で「データベースを作成」を実施する際の各種項目を解説する。  

# 前提知識
## Auroraの構成
Auroraは下記の構成となっている。  
- プライマリーインスタンス（ロール：ライターインスタンス）  
書き込みと読み取りができるインスタンス
- リードレプリカ （ロール：リーダーインスタンス） 
読み取りのみ行うインスタンス。プライマリーインスタンスが停止した際はこちらがバックアップとして、プライマリーインスタンスに昇格する。
- インスタンスボリューム（ロール：リージョン別クラスター）  
書き込みと読み込みができるインスタンスとデータを管理するクラスターボリュームが分離されている。

![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/87f1c7ac-3f4b-44e4-a62a-7c31b34146fc)

### マルチAZ インスタンス
- 書き込みと読み取りを行うプライマリーインスタンスが停止したら、別のAZにあるセカンダリーインスタンスに切り替わる。
- フェイルオーバー：約60～120秒（[公式 フェイルオーバー時間](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/Concepts.MultiAZSingleStandby.html)）

![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/daed0b99-5cda-43d9-b034-642ec2040e10)

### マルチAZ クラスター
- 書き込みと読み取りを行うプライマリーインスタンスが停止したら、別のAZにあるセカンダリーインスタンスに切り替わる。
- フェイルオーバー：約35秒未満（[公式 フェイルオーバー時間](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/multi-az-db-clusters-concepts.html)）
- 「マルチAZ インスタンス」との違い
  - 読み取り性能が高い
  - 準同期レプリケーションなので書き込み速度も速い
  - フェイルオーバー時間が短い

![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/5e08f920-fa59-4b1f-a44e-3e1583303593)

### リードレプリカ
- 書き込みと読み取り用のプライマリーDBと読み取り専用のDB（各AZに複数）配置させる
- あくまでフェイルオーバーの為ではなく、読み取り性能を向上させる為に行う。障害時にはリードレプリカを手動でプライマリーインスタンスに昇格させることができる。  
![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/4f443bd2-1165-48ed-ab05-31fb8ac1eb17)  
![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/8f384a67-6423-43fa-b321-12afda8be9e7)



###参考資料 
- [公式 マルチAZインスタンスのフェイルオーバー時間](https://aws.amazon.com/jp/rds/features/multi-az/)
- [マルチAZ / リードレプリカ 違い](https://www.stylez.co.jp/columns/understand_the_difference_between_amazonrds_multi-az_and_read_replica_high_availability_and_read_scaling/)
**<各DB構成>**  
- [公式 マルチAZインスタンス構成](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/Concepts.MultiAZSingleStandby.html)
- [公式 マルチAZクラスター構成](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/multi-az-db-clusters-concepts.html)
- [公式 リードレプリカ構成](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/USER_ReadRepl.html)


## RDS Proxy
### 接続プーリング
同時接続に伴うオーバーヘッドを削減できる。RDSとLambdaは相性が悪く、RDSの同時接続数に関係なくリクエストが来た分処理を実行する為、RDSの同時接続数が上限に達し、Lambdaでエラーとなってしまう事がある。  
RDS Proxyを経由させると、RDSの同時接続数を軽減できる。
RDS Proxyは、RDS データベースインスタンスに確立した接続のプールを管理し、新しい接続が確立する際に通常発生するデータベースコンピューティングおよびメモリリソースを減らすことができる。（使いまわして、接続数を節約する）  
※RDSの同時接続数はインスタンスタイプによってデフォルト値が異なる。同時接続数を増やしたい場合、基本的にデフォルトから変更せず、インスタンスタイプを上げる。

**<RDS　Proxy プーリングの仕組み>**  
![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/80cbc838-bfd1-438a-af94-c36d6949b709)  

**<RDS　Proxy を経由した際のDB接続数比較>**  
![image](https://github.com/adgjmptwgw/aws-practice/assets/66456130/139b11a9-050b-496a-b565-f75a47becb46)  

**<参考資料>**  
[RDS同時接続数の上限](https://kakkoyakakko2.hatenablog.com/entry/aws/aurora/max-connections)


### RDS Proxy の認証
ユーザー名 / パスワード認証しか対応していないDBサーバーでもRDS Proxy への接続はIAM認証を利用することができる。

### フェイルオーバーによる高可用性
元のデータベースインスタンスが使用できなくなったときに、別のインスタンスに置き換える機能。  
元のDBインスタンスが使用できなくなると、RDS Proxy はアイドル状態（停止や再起動を伴わない、通常使用している状態を維持したまま）のアプリケーション接続を切断せずにスタンバイデータベースに接続します。  
AuroraおよびRDSデータベースのフェールオーバー時間が、最大で66％ 短縮されます。


# 手順
## 追加設定
### 暗号化
- 暗号を有効化  
AWS Well-Architected のベストプラクティスでは有効に設定するのが推奨されている。　
**<メリット>**  
- データが暗号化され、セキュリティーが高まる。
**<デメリット>**  
- m3.medium 以上のインスタンスタイプを設定する必要がある。たぶん・・・

### バックアップ  
- バックアップ保持期間
S3に自動バックアップされる。
